#include "dbghelp.h"

#pragma comment(linker, "/export:SymGetSymPrev64=dbghelp_old.SymGetSymPrev64")
#pragma comment(linker, "/export:DbgHelpCreateUserDump=dbghelp_old.DbgHelpCreateUserDump")
#pragma comment(linker, "/export:DbgHelpCreateUserDumpW=dbghelp_old.DbgHelpCreateUserDumpW")
#pragma comment(linker, "/export:EnumerateLoadedModules64=dbghelp_old.EnumerateLoadedModules64")
#pragma comment(linker, "/export:EnumerateLoadedModules=dbghelp_old.EnumerateLoadedModules")
#pragma comment(linker, "/export:ExtensionApiVersion=dbghelp_old.ExtensionApiVersion")
#pragma comment(linker, "/export:FindDebugInfoFile=dbghelp_old.FindDebugInfoFile")
#pragma comment(linker, "/export:FindDebugInfoFileEx=dbghelp_old.FindDebugInfoFileEx")
#pragma comment(linker, "/export:FindExecutableImage=dbghelp_old.FindExecutableImage")
#pragma comment(linker, "/export:FindExecutableImageEx=dbghelp_old.FindExecutableImageEx")
#pragma comment(linker, "/export:FindFileInPath=dbghelp_old.FindFileInPath")
#pragma comment(linker, "/export:FindFileInSearchPath=dbghelp_old.FindFileInSearchPath")
#pragma comment(linker, "/export:GetTimestampForLoadedLibrary=dbghelp_old.GetTimestampForLoadedLibrary")
#pragma comment(linker, "/export:ImageDirectoryEntryToData=dbghelp_old.ImageDirectoryEntryToData")
#pragma comment(linker, "/export:ImageDirectoryEntryToDataEx=dbghelp_old.ImageDirectoryEntryToDataEx")
#pragma comment(linker, "/export:ImageNtHeader=dbghelp_old.ImageNtHeader")
#pragma comment(linker, "/export:ImageRvaToSection=dbghelp_old.ImageRvaToSection")
#pragma comment(linker, "/export:ImageRvaToVa=dbghelp_old.ImageRvaToVa")
#pragma comment(linker, "/export:ImagehlpApiVersion=dbghelp_old.ImagehlpApiVersion")
#pragma comment(linker, "/export:ImagehlpApiVersionEx=dbghelp_old.ImagehlpApiVersionEx")
#pragma comment(linker, "/export:MakeSureDirectoryPathExists=dbghelp_old.MakeSureDirectoryPathExists")
#pragma comment(linker, "/export:MapDebugInformation=dbghelp_old.MapDebugInformation")
#pragma comment(linker, "/export:MiniDumpReadDumpStream=dbghelp_old.MiniDumpReadDumpStream")
//#pragma comment(linker, "/export:MiniDumpWriteDump=dbghelp_old.MiniDumpWriteDump")
#pragma comment(linker, "/export:SearchTreeForFile=dbghelp_old.SearchTreeForFile")
#pragma comment(linker, "/export:StackWalk64=dbghelp_old.StackWalk64")
#pragma comment(linker, "/export:StackWalk=dbghelp_old.StackWalk")
#pragma comment(linker, "/export:SymCleanup=dbghelp_old.SymCleanup")
#pragma comment(linker, "/export:SymEnumSourceFiles=dbghelp_old.SymEnumSourceFiles")
#pragma comment(linker, "/export:SymEnumSym=dbghelp_old.SymEnumSym")
#pragma comment(linker, "/export:SymEnumSymbols=dbghelp_old.SymEnumSymbols")
#pragma comment(linker, "/export:SymEnumTypes=dbghelp_old.SymEnumTypes")
#pragma comment(linker, "/export:SymEnumerateModules64=dbghelp_old.SymEnumerateModules64")
#pragma comment(linker, "/export:SymEnumerateModules=dbghelp_old.SymEnumerateModules")
#pragma comment(linker, "/export:SymEnumerateSymbols64=dbghelp_old.SymEnumerateSymbols64")
#pragma comment(linker, "/export:SymEnumerateSymbols=dbghelp_old.SymEnumerateSymbols")
#pragma comment(linker, "/export:SymEnumerateSymbolsW64=dbghelp_old.SymEnumerateSymbolsW64")
#pragma comment(linker, "/export:SymEnumerateSymbolsW=dbghelp_old.SymEnumerateSymbolsW")
#pragma comment(linker, "/export:SymFindFileInPath=dbghelp_old.SymFindFileInPath")
#pragma comment(linker, "/export:SymFromAddr=dbghelp_old.SymFromAddr")
#pragma comment(linker, "/export:SymFromName=dbghelp_old.SymFromName")
#pragma comment(linker, "/export:SymFunctionTableAccess64=dbghelp_old.SymFunctionTableAccess64")
#pragma comment(linker, "/export:SymFunctionTableAccess=dbghelp_old.SymFunctionTableAccess")
#pragma comment(linker, "/export:SymGetFileLineOffsets64=dbghelp_old.SymGetFileLineOffsets64")
#pragma comment(linker, "/export:SymGetLineFromAddr64=dbghelp_old.SymGetLineFromAddr64")
#pragma comment(linker, "/export:SymGetLineFromAddr=dbghelp_old.SymGetLineFromAddr")
#pragma comment(linker, "/export:SymGetLineFromName64=dbghelp_old.SymGetLineFromName64")
#pragma comment(linker, "/export:SymGetLineFromName=dbghelp_old.SymGetLineFromName")
#pragma comment(linker, "/export:SymGetLineNext64=dbghelp_old.SymGetLineNext64")
#pragma comment(linker, "/export:SymGetLineNext=dbghelp_old.SymGetLineNext")
#pragma comment(linker, "/export:SymGetLinePrev64=dbghelp_old.SymGetLinePrev64")
#pragma comment(linker, "/export:SymGetLinePrev=dbghelp_old.SymGetLinePrev")
#pragma comment(linker, "/export:SymGetModuleBase64=dbghelp_old.SymGetModuleBase64")
#pragma comment(linker, "/export:SymGetModuleBase=dbghelp_old.SymGetModuleBase")
#pragma comment(linker, "/export:SymGetModuleInfo64=dbghelp_old.SymGetModuleInfo64")
#pragma comment(linker, "/export:SymGetModuleInfo=dbghelp_old.SymGetModuleInfo")
#pragma comment(linker, "/export:SymGetModuleInfoW64=dbghelp_old.SymGetModuleInfoW64")
#pragma comment(linker, "/export:SymGetModuleInfoW=dbghelp_old.SymGetModuleInfoW")
#pragma comment(linker, "/export:SymGetOptions=dbghelp_old.SymGetOptions")
#pragma comment(linker, "/export:SymGetSearchPath=dbghelp_old.SymGetSearchPath")
#pragma comment(linker, "/export:SymGetSymFromAddr64=dbghelp_old.SymGetSymFromAddr64")
#pragma comment(linker, "/export:SymGetSymFromAddr=dbghelp_old.SymGetSymFromAddr")
#pragma comment(linker, "/export:SymGetSymFromName64=dbghelp_old.SymGetSymFromName64")
#pragma comment(linker, "/export:SymGetSymFromName=dbghelp_old.SymGetSymFromName")
#pragma comment(linker, "/export:SymGetSymNext64=dbghelp_old.SymGetSymNext64")
#pragma comment(linker, "/export:SymGetSymNext=dbghelp_old.SymGetSymNext")
#pragma comment(linker, "/export:SymGetSymPrev=dbghelp_old.SymGetSymPrev")
#pragma comment(linker, "/export:SymGetTypeFromName=dbghelp_old.SymGetTypeFromName")
#pragma comment(linker, "/export:SymGetTypeInfo=dbghelp_old.SymGetTypeInfo")
#pragma comment(linker, "/export:SymInitialize=dbghelp_old.SymInitialize")
#pragma comment(linker, "/export:SymLoadModule64=dbghelp_old.SymLoadModule64")
#pragma comment(linker, "/export:SymLoadModule=dbghelp_old.SymLoadModule")
#pragma comment(linker, "/export:SymLoadModuleEx=dbghelp_old.SymLoadModuleEx")
#pragma comment(linker, "/export:SymMatchFileName=dbghelp_old.SymMatchFileName")
#pragma comment(linker, "/export:SymMatchString=dbghelp_old.SymMatchString")
#pragma comment(linker, "/export:SymRegisterCallback64=dbghelp_old.SymRegisterCallback64")
#pragma comment(linker, "/export:SymRegisterCallback=dbghelp_old.SymRegisterCallback")
#pragma comment(linker, "/export:SymRegisterFunctionEntryCallback64=dbghelp_old.SymRegisterFunctionEntryCallback64")
#pragma comment(linker, "/export:SymRegisterFunctionEntryCallback=dbghelp_old.SymRegisterFunctionEntryCallback")
#pragma comment(linker, "/export:SymSetContext=dbghelp_old.SymSetContext")
#pragma comment(linker, "/export:SymSetOptions=dbghelp_old.SymSetOptions")
#pragma comment(linker, "/export:SymSetSearchPath=dbghelp_old.SymSetSearchPath")
#pragma comment(linker, "/export:SymSetSymWithAddr64=dbghelp_old.SymSetSymWithAddr64")
#pragma comment(linker, "/export:SymUnDName64=dbghelp_old.SymUnDName64")
#pragma comment(linker, "/export:SymUnDName=dbghelp_old.SymUnDName")
#pragma comment(linker, "/export:SymUnloadModule64=dbghelp_old.SymUnloadModule64")
#pragma comment(linker, "/export:SymUnloadModule=dbghelp_old.SymUnloadModule")
#pragma comment(linker, "/export:UnDecorateSymbolName=dbghelp_old.UnDecorateSymbolName")
#pragma comment(linker, "/export:UnmapDebugInformation=dbghelp_old.UnmapDebugInformation")
#pragma comment(linker, "/export:WinDbgExtensionDllInit=dbghelp_old.WinDbgExtensionDllInit")
#pragma comment(linker, "/export:dbghelp=dbghelp_old.dbghelp")
#pragma comment(linker, "/export:dh=dbghelp_old.dh")
#pragma comment(linker, "/export:lm=dbghelp_old.lm")
#pragma comment(linker, "/export:lmi=dbghelp_old.lmi")
#pragma comment(linker, "/export:omap=dbghelp_old.omap")
#pragma comment(linker, "/export:srcfiles=dbghelp_old.srcfiles")
#pragma comment(linker, "/export:sym=dbghelp_old.sym")
#pragma comment(linker, "/export:vc7fpo=dbghelp_old.vc7fpo")

BOOL WINAPI MiniDumpWriteDump(HANDLE hProcess, DWORD ProcessId, HANDLE hFile, int DumpType, void *ExceptionParam, void *UserStreamParam, void *CallbackParam)
{
	static HMODULE dbghelpHandle = LoadLibraryW(L"dbghelp_old.dll");
	static auto pfnMiniDumpWriteDump = reinterpret_cast<decltype(&MiniDumpWriteDump)>(GetProcAddress(dbghelpHandle, "MiniDumpWriteDump"));

	if (dbghelpHandle && pfnMiniDumpWriteDump)
		return pfnMiniDumpWriteDump(hProcess, ProcessId, hFile, DumpType | 0x00000040 /* MiniDumpWithIndirectlyReferencedMemory */, ExceptionParam, UserStreamParam, CallbackParam);

	return FALSE;
}